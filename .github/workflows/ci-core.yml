name: ci-core
run-name: ${{ github.head_ref || github.ref_name }}-ci-core-net${{ inputs.dotnet-major }}

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: '.NET SDK version to use'
        type: string
        required: true
      dotnet-major:
        description: '.NET major version for naming'
        type: string
        required: true

  workflow_dispatch:
    inputs:
      dotnet-version:
        description: '.NET SDK version to use'
        type: string
        default: '8.0.410'
        required: false
      dotnet-major:
        description: '.NET major version for naming'
        default: '8'
        type: string
        required: false

concurrency:
  group: ci-core-${{ github.event.number }}-net${{ inputs.dotnet-major }}
  cancel-in-progress: true


jobs:

  compile:
    name: "🔨 Compile Projects - .NET ${{ inputs.dotnet-major }}"
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: "Build Projects"
        run: |
          dotnet restore
          dotnet build /p:EnforceCodeStyleInBuild=false /p:TreatWarningsAsErrors=false

      - name: "Cache Build Output"
        uses: actions/cache@v4
        with:
          path: |
            **/obj
            **/bin
            **/nupkg
          key: ${{ runner.os }}-net${{ inputs.dotnet-major }}-build-${{ github.sha }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-net${{ inputs.dotnet-major }}-build-${{ github.sha }}

  # Analyzer jobs

  analyzer-style-check:
    name: "🔍 Check Style: Analyzers"
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: "Check Code Formatting"
        if: ${{ !cancelled() }}
        run: |
          dotnet format Analyzers/GdUnit4Analyzers.csproj --verify-no-changes --verbosity diagnostic
          dotnet format Analyzers.Test/GdUnit4Analyzers.Tests.csproj --verify-no-changes --verbosity diagnostic


  analyzer-tests:
    name: "🧪 Test: Analyzers"
    needs: compile
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: "Restore Build Cache"
        if: ${{ !cancelled() }}
        uses: actions/cache@v4
        with:
          path: |
            **/obj
            **/bin
            **/nupkg
          key: ${{ runner.os }}-net${{ inputs.dotnet-major }}-build-${{ github.sha }}-${{ github.run_id }}

      - name: "Run Unit Tests"
        if: ${{ !cancelled() }}
        run: |
          cd Analyzers.Test
          dotnet test --no-build --settings .runsettings --verbosity normal

      - name: "Upload Unit Test Reports"
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          retention-days: 10
          name: artifact_analyzer
          path: |
            Analyzers.Test/TestResults/test-result.trx
            Analyzers.Test/TestResults/test-result.html

  # API
  api-style-check:
    name: "🔍 Check Style: API"
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: "Check Code Formatting"
        if: ${{ !cancelled() }}
        run: |
          dotnet format Api/GdUnit4Api.csproj --verify-no-changes --verbosity diagnostic
        # dotnet format Api.Test/GdUnit4ApiTest.csproj --verify-no-changes --verbosity diagnostic


  # Adapter jobs
  test-adapter-test:
    name: "🧪 Test: TestAdapter"
    needs: compile
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: "Restore Build Cache"
        if: ${{ !cancelled() }}
        uses: actions/cache@v4
        with:
          path: |
            **/obj
            **/bin
            **/nupkg
          key: ${{ runner.os }}-net${{ inputs.dotnet-major }}-build-${{ github.sha }}-${{ github.run_id }}

      - name: "Run Unit Tests"
        if: ${{ !cancelled() }}
        run: |
          cd TestAdapter.Test
          dotnet test --settings .runsettings --no-build --verbosity normal

      - name: "Upload Unit Test Reports"
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          retention-days: 10
          name: artifact_adapter_tests
          path: |
            ./TestAdapter.Test/TestResults/test-result.trx
            ./TestAdapter.Test/TestResults/test-result.html


  api-tests:
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        godot-version: [ '4.2', '4.2.1', '4.2.2', '4.3', '4.4' ]
        godot-status: [ 'stable' ]
      #  include:
      #    - godot-version: '4.4'
      #      godot-status: 'dev3'


    name: "🧪 Test: API on Godot-v${{ matrix.godot-version }}-${{ matrix.godot-status }}"
    needs: [ compile ]
    uses: ./.github/workflows/unit-tests.yml
    with:
      godot-version: ${{ matrix.godot-version }}
      godot-status: ${{ matrix.godot-status }}
      dotnet-version: ${{ inputs.dotnet-version }}


  finalize:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    name: Final Results
    needs: [ analyzer-style-check, analyzer-tests, api-style-check, api-tests, test-adapter-test ]
    steps:
      - run: exit 1
        if: >-
          ${{
               contains(needs.*.result, 'failure')
            || contains(needs.*.result, 'cancelled')
          }}
