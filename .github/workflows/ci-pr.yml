name: ci-pr
run-name: ${{ github.head_ref || github.ref_name }}-ci-pr

on:
  pull_request:
    paths-ignore:
      - '**.jpg'
      - '**.png'
      - '**.md'
  #- '**.yml'
  workflow_dispatch:


concurrency:
  group: ci-pr-${{ github.event.number }}
  cancel-in-progress: true


jobs:

  setup-dotnet:
    name: "🔧 Setup .NET"
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 1
    steps:
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

  compile:
    name: "🔨 Compile Projects"
    needs: setup-dotnet
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: "Build Projects"
        run: |
          dotnet restore
          dotnet build

      - name: "Cache Build Output"
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-

  # Analyzer jobs

  analyzer-style-check:
    name: "🔍 Analyzer Code Style Check"
    needs: compile
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: "Restore Build Cache"
        if: ${{ !cancelled() }}
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: "Install dotnet-format"
        if: ${{ !cancelled() }}
        run: dotnet tool install -g dotnet-format

      - name: "Check Code Formatting"
        if: ${{ !cancelled() }}
        run: dotnet format ./Analyzers/GdUnit4Analyzers.csproj --verify-no-changes --verbosity diagnostic

  analyzer-tests:
    name: "🧪 Analyzer Tests"
    needs: compile
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 3
    outputs:
      test_status: ${{ steps.run_tests.outcome }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: "Restore Build Cache"
        if: ${{ !cancelled() }}
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: "Run Unit Tests"
        if: ${{ !cancelled() }}
        id: run_tests
        run: |
          cd Analyzers.Test
          dotnet test GdUnit4Analyzers.Tests.csproj --settings .runsettings --no-build --verbosity detailed

      - name: "Upload Unit Test Reports"
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          retention-days: 10
          name: artifact_analyzer
          path: |
            ./TestResults/test-result.trx
            ./TestResults/test-result.html


  # Adapter jobs
  test-adapter-test:
    name: "🐧 TestAdapter Tests"
    needs: compile
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: "Restore Build Cache"
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: "Run Unit Tests"
        if: ${{ !cancelled() }}
        run: |
          cd TestAdapter.Test
          dotnet test GdUnit4TestAdapter.Tests.csproj --settings .runsettings --no-build --verbosity normal

      - name: "Upload Unit Test Reports"
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          retention-days: 10
          name: artifact_adapter_tests
          path: |
            ./TestAdapter.Test/TestResults/test-result.trx
            ./TestAdapter.Test/TestResults/test-result.html


  unit-tests:
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        godot-version: [ '4.2', '4.2.1', '4.2.2', '4.3', '4.4' ]
        godot-status: [ 'stable' ]
      #  include:
      #    - godot-version: '4.4'
      #      godot-status: 'dev3'


    name: "🐧 Test Godot-v${{ matrix.godot-version }}-${{ matrix.godot-status }}"
    uses: ./.github/workflows/unit-tests.yml
    with:
      godot-version: ${{ matrix.godot-version }}
      godot-status: ${{ matrix.godot-status }}


  finalize:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    name: Final Results
    needs: [ analyzer-style-check, analyzer-tests, test-adapter-test, unit-tests ]
    steps:
      - run: exit 1
        if: >-
          ${{
               contains(needs.*.result, 'failure')
            || contains(needs.*.result, 'cancelled')
          }}
